%% Small Group Interest Form Submission Flow
%% Code anchors:
%%   Modal: app/get-involved/components/SmallGroupInterestModal.tsx
%%   Action: app/get-involved/actions.ts:submitSmallGroupInterestForm()
%%   PCO: lib/planning-center.ts:findOrCreatePerson()
%%   Email: lib/email.ts:sendSmallGroupInterestNotification()

sequenceDiagram
    autonumber
    participant User
    participant Modal as SmallGroupInterestModal
    participant Action as submitSmallGroupInterestForm
    participant PCO as findOrCreatePerson
    participant Email as sendSmallGroupInterestNotification
    participant Resend as Resend API

    User->>Modal: Click "Find a Group"
    Modal->>Modal: Open dialog
    User->>Modal: Fill form (single page)
    Modal->>Modal: Client validation (Zod)
    Modal->>Action: Submit payload

    Action->>Action: Server validation (Zod)
    alt Validation fails
        Action-->>Modal: {success: false, error}
        Modal-->>User: Show error banner
    end

    Action->>PCO: findOrCreatePerson(input)
    PCO->>PCO: Build Basic Auth header
    PCO->>PCO: GET /people?search_name_or_email_or_phone_number
    
    alt Person found
        PCO->>PCO: Check existing emails/phones
        PCO->>PCO: Add email if missing
        PCO->>PCO: Add phone if missing
        PCO-->>Action: {success, isExisting: true, emailAdded, phoneAdded}
    else Person not found
        PCO->>PCO: POST /people/v2/people (create)
        PCO->>PCO: POST /people/{id}/emails
        PCO->>PCO: POST /people/{id}/phone_numbers
        PCO-->>Action: {success, isExisting: false, emailAdded, phoneAdded}
    end
    Note over PCO: Failures logged, not thrown

    Action->>Email: sendSmallGroupInterestNotification(data + pcoResult)
    Email->>Email: Render React email + plainText
    Email->>Email: Generate idempotencyKey

    loop Retry up to 3x on 429/5xx
        Email->>Resend: POST /emails
        alt Success
            Resend-->>Email: OK
            Email-->>Action: {success: true}
        else Retryable error
            Email->>Email: Exponential backoff
        else Permanent error
            Email--xAction: throw Error
        end
    end

    alt Email sent
        Action-->>Modal: {success: true}
        Modal-->>User: Show ThankYouState (mentions Cory Tutor)
        Modal->>Modal: setTimeout 5s
        Modal->>Modal: Auto-close dialog
    else Email failed
        Action-->>Modal: {success: false, error}
        Modal-->>User: Show error banner
    end
